<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>فاتورة - عيادات النخبة الطبية</title>

  <style>
    @page {
      size: A4;
      margin: 12mm;
    }

    body {
      font-family: "Tahoma", sans-serif;
      font-size: 14px;
      direction: rtl;
      text-align: right;
      margin: 0 auto;
      width: 210mm;
      background: #fff;
    }

    .header {
      border-bottom: 2px solid #000;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .clinic-title {
      font-size: 22px;
      font-weight: bold;
    }

    .invoice-title {
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      margin-top: 10px;
    }

    .info {
      margin-top: 10px;
      margin-bottom: 15px;
      border-bottom: 1px dashed #777;
      padding-bottom: 8px;
    }

    .info div {
      margin: 4px 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th {
      background: #f0f0f0;
      padding: 6px;
      border: 1px solid #000;
      text-align: center;
    }

    td {
      padding: 6px;
      border: 1px solid #000;
      text-align: center;
    }

    .notes {
      margin-top: 20px;
      padding: 10px;
      border: 1px dashed #888;
      min-height: 40px;
      font-size: 13px;
    }

    .footer {
      text-align: center;
      margin-top: 25px;
      padding-top: 10px;
      border-top: 1px solid #000;
      font-size: 12px;
      color: #555;
    }
  </style>

  <script>
    function getParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name) || "";
    }

    function decodeLines(encoded) {
      if (!encoded) return [];
      try {
        const json = atob(encoded); // Base64 decode
        return JSON.parse(json);   // JSON → Array
      } catch (e) {
        console.error("Error decoding lines:", e);
        return [];
      }
    }

    window.onload = () => {
      // بيانات الفاتورة
      document.getElementById("Customer").innerText = getParam("Customer");
      document.getElementById("InvoiceNo").innerText = getParam("InvoiceNo");
      document.getElementById("DateTime").innerText = getParam("DateTime");
      document.getElementById("Notes").innerText = getParam("Notes");

      // معالجة الأسطر
      const encodedLines = getParam("Lines");
      const lines = decodeLines(encodedLines);

      const tbody = document.getElementById("lines-body");
      tbody.innerHTML = "";

      if (lines.length === 0) {
        tbody.innerHTML = <tr><td colspan="5">لا توجد خدمات</td></tr>;
      } else {
        lines.forEach((ln, idx) => {
          tbody.innerHTML += 
            <tr>
              <td>${idx + 1}</td>
              <td>${ln.ItemName}</td>
              <td>${ln.Qty}</td>
              <td>${ln.UnitPrice}</td>
              <td>${ln.LineTotal}</td>
            </tr>
          ;
        });
      }

      // طباعة تلقائيًا
      setTimeout(() => window.print(), 300);
    };
  </script>
</head>

<body>

  <!-- رأس الفاتورة -->
  <div class="header">
    <div class="clinic-title">عيادات النخبة الطبية</div>
    <div>العراق – ميسان / العمارة – شارع التانكي</div>
    <div>هاتف: 07706617872</div>
  </div>

  <div class="invoice-title">فاتورة بيع</div>

  <!-- معلومات الفاتورة -->
  <div class="info">
    <div><strong>اسم المراجع:</strong> <span id="Customer"></span></div>
    <div><strong>رقم الوصل:</strong> <span id="InvoiceNo"></span></div>
    <div><strong>التاريخ:</strong> <span id="DateTime"></span></div>
  </div>

  <!-- جدول السطور -->
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>الخدمة</th>
        <th>العدد</th>
        <th>سعر الوحدة</th>
        <th>الإجمالي</th>
      </tr>
    </thead>
    <tbody id="lines-body"></tbody>
  </table>

  <!-- الملاحظات -->
  <div class="notes" id="Notes"></div>

  <!-- تذييل -->
  <div class="footer">
    شكراً لاختياركم عيادات النخبة الطبية
  </div>

</body>
</html>