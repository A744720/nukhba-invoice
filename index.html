<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>فاتورة - عيادات النخبة الطبية</title>
  <style>
    /* حجم الورقة A5 للطباعة */
    @page {
      size: A5 portrait;
      margin: 10mm;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .invoice-wrapper {
      max-width: 420px;          /* قريب من عرض A5 */
      margin: 10px auto;
      background: #ffffff;
      padding: 16px 18px;
      box-shadow: 0 0 4px rgba(0,0,0,0.12);
      border-radius: 8px;
      box-sizing: border-box;
    }

    .clinic-name {
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 4px;
    }

    .clinic-info {
      font-size: 11px;
      text-align: center;
      margin-bottom: 10px;
      color: #555;
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      margin: 10px 0 4px;
    }

    .meta {
      font-size: 12px;
      margin-bottom: 8px;
    }

    .meta span {
      display: block;
      margin-bottom: 2px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 6px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 4px 6px;
      text-align: center;
      vertical-align: middle;
    }

    th {
      background: #f0f0f0;
      font-weight: 600;
    }

    tfoot td {
      font-weight: 700;
      background: #fafafa;
    }

    .notes {
      font-size: 11px;
      margin-top: 8px;
    }

    .print-btn {
      margin-top: 10px;
      text-align: center;
    }

    .print-btn button {
      padding: 6px 14px;
      font-size: 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    @media print {
      body {
        background: #fff;
      }
      .print-btn {
        display: none;
      }
      .invoice-wrapper {
        box-shadow: none;
        margin: 0;
        border-radius: 0;
      }
    }
  </style>
</head>
<body>
  <div class="invoice-wrapper">
    <div class="clinic-name">عيادات النخبة الطبية</div>
    <div class="clinic-info">
      العراق / ميسان / العمارة / شارع التانكي<br>
      هاتف: 07706617872
    </div>

    <div class="meta">
      <span id="customer">اسم المراجع: -</span>
      <span id="invoiceNo">رقم الوصل: -</span>
      <span id="dateTime">التاريخ: -</span>
    </div>

    <div class="section-title">فاتورة تجميلية</div>

    <table>
      <thead>
        <tr>
          <th style="width:30px">#</th>
          <th>الخدمة</th>
          <th style="width:60px">العدد</th>
          <th style="width:80px">سعر الوحدة</th>
          <th style="width:80px">الإجمالي</th>
        </tr>
      </thead>
      <tbody id="linesBody">
        <!-- يملأ بالـ JS -->
      </tbody>
      <tfoot>
        <tr>
          <td colspan="4">المجموع الكلي</td>
          <td id="totalCell">0</td>
        </tr>
      </tfoot>
    </table>

    <div class="notes" id="notesBox" style="display:none;">
      <strong>الملاحظات:</strong>
      <span id="notesText"></span>
    </div>

    <div class="print-btn">
      <button onclick="window.print()">طباعة</button>
    </div>
  </div>

  <script>
    // قراءة الباراميترات من الرابط
    const params = new URLSearchParams(window.location.search);

    function getParam(name, def = "") {
      const v = params.get(name);
      return v ? decodeURIComponent(v) : def;
    }

    function parseList(name) {
      const raw = getParam(name, "");
      if (!raw) return [];
      // AppSheet TEXT(list) => "a, b, c"
      return raw.split(",").map(v => v.trim()).filter(v => v.length > 0);
    }

    // تعبئة البيانات الأساسية
    document.getElementById("customer").textContent =
      "اسم المراجع: " + (getParam("Customer") || "-");

    document.getElementById("invoiceNo").textContent =
      "رقم الوصل: " + (getParam("InvoiceNo") || "-");

    document.getElementById("dateTime").textContent =
      "التاريخ: " + (getParam("DateTime") || "-");
// الملاحظات
    const notes = getParam("Notes");
    if (notes && notes.trim().length > 0) {
      document.getElementById("notesText").textContent = notes;
      document.getElementById("notesBox").style.display = "block";
    }

    // قراءة القوائم من الرابط
    const qtyList        = parseList("Qty");
    const serviceList    = parseList("Service");
    const unitPriceList  = parseList("UnitPrice");
    const lineTotalList  = parseList("LineTotal");

    const tbody = document.getElementById("linesBody");

    const maxLen = Math.max(
      qtyList.length,
      serviceList.length,
      unitPriceList.length,
      lineTotalList.length
    );

    for (let i = 0; i < maxLen; i++) {
      const tr = document.createElement("tr");

      const cIndex = document.createElement("td");
      cIndex.textContent = i + 1;
      tr.appendChild(cIndex);

      const cService = document.createElement("td");
      cService.textContent = serviceList[i] || "";
      tr.appendChild(cService);

      const cQty = document.createElement("td");
      cQty.textContent = qtyList[i] || "";
      tr.appendChild(cQty);

      const cUnit = document.createElement("td");
      cUnit.textContent = unitPriceList[i] || "";
      tr.appendChild(cUnit);

      const cTotal = document.createElement("td");
      cTotal.textContent = lineTotalList[i] || "";
      tr.appendChild(cTotal);

      tbody.appendChild(tr);
    }

    // مجموع الفاتورة
    const total = getParam("Total") || "0";
    document.getElementById("totalCell").textContent = total;

    // طباعة تلقائية عند الفتح (اختياري)
    window.addEventListener("load", () => {
      window.print();
    });
  </script>
</body>
</html>
